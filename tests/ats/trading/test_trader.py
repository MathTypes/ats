import logging

import pandas as pd
import ray

from hydra import initialize, compose
import math
import pandas_market_calendars as mcal
import torch

from ats.app.env_mgr import EnvMgr
from ats.market_data import market_data_mgr
from ats.model import model_utils
from ats.trading.trader import Trader


def test_create_trader():
    pd.set_option("display.max_columns", None)
    pd.set_option("display.max_rows", None)
    with initialize(version_base=None, config_path="../../../conf"):
        cfg = compose(config_name="test", overrides=[], return_hydra_config=True)
        env_mgr = EnvMgr(cfg)
        md_mgr = market_data_mgr.MarketDataMgr(env_mgr)
        market_cal = md_mgr.market_cal
        wandb_logger = None
        data_module = md_mgr.data_module()
        model = model_utils.get_patch_tft_supervised_model(
            cfg, data_module, env_mgr.heads
        )
        train_dataset = data_module.training
        train_data = data_module.train_data
        future_data = data_module.test_data

        trader = Trader(
            md_mgr,
            model,
            wandb_logger,
            env_mgr.target_size,
            future_data,
            train_data,
            train_dataset,
            cfg,
            market_cal,
        )
        first_train_data_row = train_data.iloc[0]
        # 2008-02-07 08:30:00 - we need 201 prior intervals. Each day
        # has about 40 intervals. It is strange why we go to 2008-02-07 instead
        # of 2008-01-10.
        assert first_train_data_row["timestamp"] == 1243807200


def assert_map_close(test_map, expected_map):
    for key, val in expected_map.items():
        if isinstance(val, (int, float)):
            assert math.isclose(
                test_map[key], val, rel_tol=0.15
            ), f"{key} should be close"
        else:
            assert test_map[key] == expected_map[key], f"{key} should match"


def test_on_interval_basic():
    pd.set_option("display.max_columns", None)
    pd.set_option("display.max_rows", None)
    with initialize(version_base=None, config_path="../../../conf"):
        cfg = compose(config_name="test",
                      overrides=[
                          "job.test_start_date=2010-07-30",
                          "job.test_end_date=2010-07-30",
                      ],
                      return_hydra_config=True)
        env_mgr = EnvMgr(cfg)
        md_mgr = market_data_mgr.MarketDataMgr(env_mgr)
        market_cal = md_mgr.market_cal
        ray.shutdown()
        ray.init(object_store_memory=30*1024*1024*1024,
                 storage=f"{cfg.dataset.base_dir}/cache")

        wandb_logger = None
        data_module = md_mgr.data_module()
        model = model_utils.get_patch_tft_supervised_model(
            cfg, data_module, env_mgr.heads
        )
        train_dataset = data_module.training
        train_data = data_module.train_data
        future_data = data_module.test_data

        trader = Trader(
            md_mgr,
            model,
            wandb_logger,
            env_mgr.target_size,
            future_data,
            train_data,
            train_dataset,
            cfg,
            market_cal,
        )
        first_train_data_row = train_data.iloc[0]
        logging.error(f"first_train_data_row:{first_train_data_row}")
        last_train_data_row = train_data.iloc[-1]
        logging.error(f"last_train_data_row:{last_train_data_row}")
        test_date = cfg.job.test_start_date
        schedule = market_cal.schedule(start_date=test_date, end_date=test_date)
        time_range = mcal.date_range(
            schedule, frequency=f"{cfg.job.time_interval_minutes}min"
        )
        logging.error(f"sod {test_date}, schedule:{time_range}")
        utc_time1 = time_range[0]
        row1 = trader.on_interval(utc_time1)
        logging.error(f"on_interval_result:{row1}")
        expected_row1 = {'ticker': 'ES', 'time_idx': 27888, 'day_of_week': 3.0, 'hour_of_day': 19.0,
                         'year': 2010.0, 'month': 7.0, 'day_of_month': 29.0,
                         'y_close_cum_max': 0.003946131560951471, 'y_close_cum_min': -0.21561987698078156,
                         'y_close_cum': -0.21561987698078156, 'close_back_cumsum': 0,
                         'close_back': 0.00017189514438609166, 'dm_str': '20100729-230000',
                         'decoder_time_idx': 27888, 'y_hat_cum_max': -0.00020393074373714626,
                         'y_hat_cum_min': -0.006001484114676714, 'y_hat_cum': -0.005608296487480402,
                         'error_cum_max': -0.0042, 'error_cum_min': 0.2096, 'rmse': 0, 'mae': 0,
                         'error': 0.21001158049330115, 'last_position': 0, 'new_position': -5.0,
                         'delta_position': -5.0, 'px': 954.25, 'pnl_delta': -0.0}
        logging.error(f"row1:{row1}")
        logging.error(f"expected_row1:{expected_row1}")
        assert_map_close(row1, expected_row1)
        expected_pnl1 = {
            "ticker": "ES",
            "px": 954.25,
            "last_px": 954.75,
            "pos": -5.0,
            "pnl": 0.0,
        }
        logging.error(f"pnl:{trader.pnl_df.iloc[-1]}")
        logging.error(f"expected_pnl1:{expected_pnl1}")
        assert_map_close(trader.pnl_df.iloc[-1], expected_pnl1)

        expected_data_row1 = {
            'new_idx': 'ES_1280442600', 'open': 954.75, 'high': 954.75, 'low': 954.0, 'close': 954.25, 'volume': 906, 'dv': 864617.25, 'month': 7.0, 'year': 2010.0, 'hour_of_day': 18.0, 'day_of_week': 3.0, 'day_of_month': 29.0, 'time_idx': 27887, 'ticker': 'ES', 'timestamp': 1280442600.0, 'week_of_year': 30.0, 'month_of_year': 7.0, 'weekly_close_time': 1280520000.0, 'last_weekly_close_time': 1279915200.0, 'monthly_close_time': 1280520000.0, 'last_monthly_close_time': 1277928000.0, 'option_expiration_time': 1282334400.0, 'last_option_expiration_time': 1279310400.0, 'time_to_low_1d_ff_shift_1d': 50400.0, 'time_to_low_5d_ff_shift_5d': 50400.0, 'time_to_low_11d_ff_shift_11d': 1175400.0, 'time_to_low_21d_ff_shift_21d': 2300400.0, 'time_to_high_1d_ff_shift_1d': 261000.0, 'time_to_high_5d_ff_shift_5d': 561600.0, 'time_to_high_11d_ff_shift_11d': 561600.0, 'time_to_high_21d_ff_shift_21d': 561600.0, 'time_to_last_macro_event_imp1': -28800.0, 'time_to_last_macro_event_imp2': -102600.0, 'time_to_last_macro_event_imp3': -36000.0, 'time_to_next_macro_event_imp1': 55800.0, 'time_to_next_macro_event_imp2': 50400.0, 'time_to_next_macro_event_imp3': 50400.0, 'time_to_low_1d_ff': -25200.0, 'time_to_low_5d_ff': -815400.0, 'time_to_low_11d_ff': -2066400.0, 'time_to_low_21d_ff': -2066400.0, 'time_to_low_51d_ff': -2066400.0, 'time_to_low_101d_ff': -2066400.0, 'time_to_low_201d_ff': -44073000.0, 'time_to_high_1d_ff': -36000.0, 'time_to_high_5d_ff': -207000.0, 'time_to_high_11d_ff': -207000.0, 'time_to_high_21d_ff': -207000.0, 'time_to_high_51d_ff': -8177400.0, 'time_to_high_101d_ff': -8177400.0, 'time_to_high_201d_ff': -8177400.0, 'time_to_low_5_ff': 0.0, 'time_to_low_11_ff': 0.0, 'time_to_low_21_ff': -25200.0, 'time_to_low_51_ff': -25200.0, 'time_to_low_101_ff': -25200.0, 'time_to_low_201_ff': -815400.0, 'time_to_high_5_ff': -12600.0, 'time_to_high_11_ff': -36000.0, 'time_to_high_21_ff': -36000.0, 'time_to_high_51_ff': -207000.0, 'time_to_high_101_ff': -207000.0, 'time_to_high_201_ff': -207000.0, 'time_to_weekly_close': 77400.0, 'time_to_monthly_close': 77400.0, 'time_to_option_expiration': 1891800.0, 'time_to_new_york_open': 54000.0, 'time_to_new_york_last_open': -32400.0, 'time_to_new_york_last_close': -9000.0, 'time_to_new_york_close': 77400.0, 'time_to_london_open': 30600.0, 'time_to_london_last_open': -55800.0, 'time_to_london_close': 61200.0, 'time_to_london_last_close': -55800.0, 'ret_from_kc_10_05_high': -0.0019132332648590378, 'ret_from_kc_10_10_high': -0.002912011923217328, 'ret_from_kc_10_15_high': -0.003909794018031043, 'ret_from_kc_10_20_high': -0.004906581536023857, 'ret_from_kc_10d_05_high': -0.004723562425574812, 'ret_from_kc_10d_10_high': -0.012135284243497857, 'ret_from_kc_10d_15_high': -0.019492476352360733, 'ret_from_kc_10d_20_high': -0.026795935270301996, 'ret_from_kc_10w_05_high': -0.00958095323083441, 'ret_from_kc_10w_10_high': -0.02737835045058823, 'ret_from_kc_10w_15_high': -0.0448645310965512, 'ret_from_kc_10w_20_high': -0.06205019263466216, 'ret_from_kc_10m_05_high': -0.016237689667012667, 'ret_from_kc_10m_10_high': -0.04976519333086227, 'ret_from_kc_10m_15_high': -0.08220497356322642, 'ret_from_kc_10m_20_high': -0.11362539562978835, 'ret_from_kc_10_05_low': 8.732171920744491e-05, 'ret_from_kc_10_10_low': 0.0010891020482537428, 'ret_from_kc_10_15_low': 0.002091886947572341, 'ret_from_kc_10_20_low': 0.0030956784339188914, 'ret_from_kc_10d_05_low': 0.010266746163004825, 'ret_from_kc_10d_10_low': 0.01784701735417915, 'ret_from_kc_10d_15_low': 0.025485188231368028, 'ret_from_kc_10d_20_low': 0.03318215010662584, 'ret_from_kc_10w_05_low': 0.026993231511747595, 'ret_from_kc_10w_10_low': 0.04579449752161313, 'ret_from_kc_10w_15_low': 0.06495603552035867, 'ret_from_kc_10w_20_low': 0.08449192284392826, 'ret_from_kc_10m_05_low': 0.05439055709048102, 'ret_from_kc_10m_10_low': 0.0916679000373648, 'ret_from_kc_10m_15_low': 0.13038882999814927, 'ret_from_kc_10m_20_low': 0.17066967445136427, 'ret_from_kc_10_05_mid': -0.0009134560502737088, 'ret_from_kc_10d_05_mid': 0.0027435034627547594, 'ret_from_kc_10w_05_mid': 0.008538939585529981, 'ret_from_kc_10m_05_mid': 0.0184530196158752, 'ret_from_close_cumsum_high_5d': 0.01382864546446072, 'ret_from_close_cumsum_high_11d': 0.01382864546446072, 'ret_from_close_cumsum_high_21d': 0.01382864546446072, 'ret_from_close_cumsum_high_51d': 0.02176586521412105, 'ret_from_close_cumsum_high_101d': 0.07594816994216202, 'ret_from_close_cumsum_high_201d': 0.07594816994216202, 'ret_from_close_cumsum_low_5d': -0.007939289199795141, 'ret_from_close_cumsum_low_11d': -0.031432655829186196, 'ret_from_close_cumsum_low_21d': -0.06553609608141286, 'ret_from_close_cumsum_low_51d': -0.06553609608141286, 'ret_from_close_cumsum_low_101d': -0.06553609608141286, 'ret_from_close_cumsum_low_201d': -0.06553609608141286, 'ret_from_high_1d': -0.00941062638358936, 'ret_from_high_1d_shift_1d': -0.00463082895982847, 'ret_from_high_5d': -0.013828645464459832, 'ret_from_high_5d_shift_5d': -0.020756104105098316, 'ret_from_high_11d': -0.013828645464459832, 'ret_from_high_11d_shift_11d': -0.020756104105098316, 'ret_from_high_21d': -0.013828645464459832, 'ret_from_high_21d_shift_21d': -0.020756104105098316, 'ret_from_high_51d': -0.02176586521412016, 'ret_from_high_101d': -0.07594816994216114, 'ret_from_high_201d': -0.07594816994216114, 'ret_from_low_1d': 0.002754348444697463, 'ret_from_low_1d_shift_1d': 0.007419583687881648, 'ret_from_low_5d': 0.007939289199795141, 'ret_from_low_5d_shift_5d': 0.007419583687881648, 'ret_from_low_11d': 0.031432655829187084, 'ret_from_low_11d_shift_11d': 0.01769036768185117, 'ret_from_low_21d': 0.06553609608141375, 'ret_from_low_21d_shift_21d': 0.0385539250194018, 'ret_from_low_51d': 0.06553609608141375, 'ret_from_low_101d': 0.06553609608141375, 'ret_from_low_201d': 0.06553609608141375, 'ret_from_high_5d_bf': -0.013828645464459832, 'ret_from_high_11d_bf': -0.013828645464459832, 'ret_from_high_21d_bf': -0.013828645464459832, 'ret_from_high_51d_bf': -0.02176586521412016, 'ret_from_low_5d_bf': 0.007939289199795141, 'ret_from_low_11d_bf': 0.031432655829187084, 'ret_from_low_21d_bf': 0.06553609608141375, 'ret_from_low_51d_bf': 0.06553609608141375, 'ret_from_close_cumsum_high_5': 0.0003437607459089165, 'ret_from_close_cumsum_high_11': 0.004288539036925165, 'ret_from_close_cumsum_high_21': 0.009410626383590248, 'ret_from_close_cumsum_high_51': 0.009410626383590248, 'ret_from_close_cumsum_high_101': 0.011961865117499748, 'ret_from_close_cumsum_high_201': 0.01382864546446072, 'ret_from_close_cumsum_low_5': 0.0, 'ret_from_close_cumsum_low_11': 0.0, 'ret_from_close_cumsum_low_21': -0.002754348444696575, 'ret_from_close_cumsum_low_51': -0.002754348444696575, 'ret_from_close_cumsum_low_101': -0.002754348444696575, 'ret_from_close_cumsum_low_201': -0.004307009845208931, 'ret_from_high_5': -0.0003437607459080283, 'ret_velocity_from_high_5': 2.7282598881589547e-08, 'ret_from_high_11': -0.004288539036924277, 'ret_velocity_from_high_11': 1.1912608435900769e-07, 'ret_from_high_21': -0.00941062638358936, 'ret_velocity_from_high_21': 2.614062884330378e-07, 'ret_from_high_51': -0.00941062638358936, 'ret_velocity_from_high_51': 4.54619632057457e-08, 'ret_from_high_101': -0.011961865117499748, 'ret_velocity_from_high_101': 5.778678800724516e-08, 'ret_from_high_201': -0.013828645464459832, 'ret_velocity_from_high_201': 6.680505055294605e-08, 'ret_from_low_5': 0.0, 'ret_velocity_from_low_5': -1.0, 'ret_from_low_11': 0.0, 'ret_velocity_from_low_11': -1.0, 'ret_from_low_21': 0.002754348444697463, 'ret_velocity_from_low_21': -1.0929954145624854e-07, 'ret_from_low_51': 0.002754348444697463, 'ret_velocity_from_low_51': -1.0929954145624854e-07, 'ret_from_low_101': 0.002754348444697463, 'ret_velocity_from_low_101': -1.0929954145624854e-07, 'ret_from_low_201': 0.004307009845209819, 'ret_velocity_from_low_201': -5.2820822237059346e-09, 'ret_from_vwap_since_last_macro_event_imp1': -0.00030447692327051357, 'ret_from_vwap_pre_macro_event_imp1': -0.007016618583503664, 'ret_from_vwap_post_macro_event_imp1': -0.0024564055245077654, 'ret_from_vwap_around_macro_event_imp1': -0.0068614550410650565, 'ret_from_vwap_since_last_macro_event_imp2': -0.001958663712748887, 'ret_from_vwap_pre_macro_event_imp2': -0.0005888921762240429, 'ret_from_vwap_post_macro_event_imp2': -0.003157235481339171, 'ret_from_vwap_around_macro_event_imp2': -0.0021633069099626923, 'ret_from_vwap_since_last_macro_event_imp3': -0.002385218188879712, 'ret_from_vwap_pre_macro_event_imp3': -0.008295729116279738, 'ret_from_vwap_post_macro_event_imp3': -0.009169941854699992, 'ret_from_vwap_around_macro_event_imp3': -0.008535163135863222, 'ret_from_vwap_since_new_york_open': -0.0010811557390164594, 'ret_from_vwap_since_london_open': -0.0028392494369526844, 'ret_from_vwap_pre_new_york_open': -0.009704568674513858, 'ret_from_vwap_post_new_york_open': -0.006949958006350343, 'daily_returns': -0.0003437016669530779, 'daily_returns_5': -0.000858811405015425, 'daily_returns_10': 0.0, 'daily_returns_20': -0.006829434864265016, 'daily_vol': 0.0014767470870684111, 'daily_vol_5': 0.0038069744168260948, 'daily_vol_10': 0.003984086664317651, 'daily_vol_20': 0.004598537614840708, 'daily_skew': 0.4267563523905285, 'daily_skew_5': 0.4353072664413625, 'daily_skew_10': 0.3071760308800967, 'daily_skew_20': -0.10705655570655616, 'daily_kurt': 30.820889433600605, 'daily_kurt_5': 19.036478232825964, 'daily_kurt_10': 13.08807175733372, 'daily_kurt_20': 9.13896331361424, 'macd_8_24': -1.4509445855693281, 'macd_16_48': -1.0216543079164406, 'macd_32_96': 0.1616560609899612, 'macd_8_24_day': 0.17423113817692268, 'macd_16_48_day': -0.30760631745357897, 'macd_32_96_day': -0.5782701182384913, 'daily_returns_1d': -0.004108885464817691, 'daily_returns_5d': 0.003450060376056552, 'daily_returns_10d': 0.003103983445421621, 'daily_returns_20d': 0.05323193916349811, 'daily_vol_1d': 0.0034548081758694824, 'daily_vol_5d': 0.010101159937913258, 'daily_vol_10d': 0.005380190417636142, 'daily_vol_20d': 0.006262232578215827, 'daily_vol_diff_1_20d': -0.002807424402346345, 'daily_skew_1d': -0.015758340497721787, 'daily_skew_5d': -0.5691681780072418, 'daily_skew_10d': -0.9734427629868059, 'daily_skew_20d': -0.8847505021495327, 'daily_kurt_1d': 6.550249502823771, 'daily_kurt_5d': 3.954291412376642, 'daily_kurt_10d': 3.1838571198693204, 'daily_kurt_20d': 1.9149053216470446, 'ret_from_last_daily_close_0': -0.00017189514438520348, 'ret_from_last_daily_close_1': -0.0041173501295475035, 'ret_from_last_daily_close_2': -0.009921395101597952, 'ret_from_last_daily_close_3': -0.008899596647572672, 'ret_from_last_daily_close_4': -0.0030896008098943994, 'ret_from_last_daily_close_5': 0.005516304282984663, 'ret_from_last_daily_close_6': 0.02277765169981638, 'ret_from_last_daily_close_7': 0.011063207047468104, 'ret_from_last_daily_close_8': 0.02242597242768518, 'ret_from_last_daily_close_9': 0.02312945469377059, 'ret_from_last_daily_close_10': 0.004307009845209819, 'ret_from_last_daily_close_11': 0.0037891881369098712, 'ret_from_last_daily_close_12': 0.0048250998317573845, 'ret_from_last_daily_close_13': 0.014022561631305663, 'ret_from_last_daily_close_14': 0.0171655710285048, 'ret_from_last_daily_close_15': 0.02049394407576255, 'ret_from_last_daily_close_16': 0.025948343100190563, 'ret_from_last_daily_close_17': 0.051139492077498794, 'ret_from_last_daily_close_18': 0.05822077450504093, 'ret_from_last_daily_close_19': 0.052587980471260565, 'ret_from_last_weekly_close_0': -0.0030896008098943994, 'ret_from_last_weekly_close_1': 0.02312945469377059, 'ret_from_last_weekly_close_2': 0.0171655710285048, 'ret_from_last_weekly_close_3': 0.05822077450504093, 'ret_from_last_weekly_close_4': 0.015069134201976198, 'ret_from_last_weekly_close_5': -0.00941062638358936, 'ret_from_last_weekly_close_6': 0.007939289199795141, 'ret_from_last_weekly_close_7': 0.02418560687784499, 'ret_from_last_weekly_close_8': 0.009152986791349349, 'ret_from_last_weekly_close_9': 0.011237044509878835, 'ret_from_last_weekly_close_10': -0.023446537878638374, 'ret_from_last_weekly_close_11': -0.00463082895982847, 'ret_from_last_weekly_close_12': -0.05680498100044851, 'ret_from_last_weekly_close_13': -0.07419392341940689, 'ret_from_last_weekly_close_14': -0.05940027848313445, 'ret_from_last_weekly_close_15': -0.06150400933425271, 'ret_from_last_weekly_close_16': -0.04897842873900515, 'ret_from_last_weekly_close_17': -0.04207958403153622, 'ret_from_last_weekly_close_18': -0.03745377039713915, 'ret_from_last_weekly_close_19': -0.030974804299430225, 'ret_from_last_monthly_close_0': 0.050777697572828906, 'ret_from_last_monthly_close_1': 0.009152986791349349, 'ret_from_last_monthly_close_2': -0.05680498100044851, 'ret_from_last_monthly_close_3': -0.04504206151086532, 'ret_from_last_monthly_close_4': 0.0001719246974065669, 'ret_from_last_monthly_close_5': 0.025595547188964396, 'ret_from_last_monthly_close_6': -0.005315057518852306, 'ret_from_last_monthly_close_7': 0.01175873828747065, 'ret_from_last_monthly_close_8': 0.054946258208208754, 'ret_from_last_monthly_close_9': 0.03926884908917394, 'ret_from_last_monthly_close_10': 0.0666380245675704, 'ret_from_last_monthly_close_11': 0.0955336876753119, 'ret_from_last_monthly_close_12': 0.14635921098348526, 'ret_from_last_monthly_close_13': 0.14536468081697684, 'ret_from_last_monthly_close_14': 0.19154394224593752, 'ret_from_last_monthly_close_15': 0.2555967738683238, 'ret_from_last_monthly_close_16': 0.3110461312521995, 'ret_from_last_monthly_close_17': 0.22758005849411322, 'ret_from_last_monthly_close_18': 0.17195770639864882, 'ret_from_last_monthly_close_19': 0.17012190782085845, 'ret_to_next_new_york_close': 0.0, 'ret_to_next_weekly_close': 0.0, 'ret_to_next_monthly_close': 0.0, 'ret_from_vwap_around_new_york_open': -0.008399044839871195, 'ret_from_vwap_pre_new_york_close': 0.0001415528361050633, 'ret_from_vwap_post_new_york_close': -0.00021990972618368687, 'ret_from_vwap_around_new_york_close': 0.00013037014380135048, 'ret_from_vwap_pre_london_open': -0.007126679470145447, 'ret_from_vwap_post_london_open': -0.006371085010262512, 'ret_from_vwap_around_london_open': -0.006863954744517287, 'ret_from_vwap_pre_london_close': -0.007126679470145447, 'ret_from_vwap_post_london_close': -0.006371085010262512, 'ret_from_vwap_around_london_close': -0.006863954744517287, 'ret_from_bb_high_5_2': -0.00047931684110036343, 'ret_from_bb_high_5_3': -0.0006329922561816304, 'ret_from_bb_high_10_2': -0.004336274374873383, 'ret_from_bb_high_10_3': -0.005873778756396497, 'ret_from_bb_high_20_2': -0.009688761308543903, 'ret_from_bb_high_20_3': -0.01338774684852595, 'ret_from_bb_high_50_2': -0.010705883578417286, 'ret_from_bb_high_50_3': -0.013855097660400162, 'ret_from_bb_high_100_2': -0.01380236739863605, 'ret_from_bb_high_100_3': -0.01735371046794487, 'ret_from_bb_high_200_2': -0.014221692370246508, 'ret_from_bb_high_200_3': -0.018085926664920038, 'ret_from_bb_low_5_2': 0.00013562108949294327, 'ret_from_bb_low_5_3': 0.0002894146760414884, 'ret_from_bb_low_10_2': 0.0018374919511510157, 'ret_from_bb_low_10_3': 0.0033869075010226624, 'ret_from_bb_low_20_2': 0.005245543262978103, 'ret_from_bb_low_20_3': 0.009014230481563246, 'ret_from_bb_low_50_2': 0.001991095248489394, 'ret_from_bb_low_50_3': 0.005190690423688693, 'ret_from_bb_low_100_2': 0.0005304851905822972, 'ret_from_bb_low_100_3': 0.00414602850198964, 'ret_from_bb_low_200_2': 0.0013863217324656674, 'ret_from_bb_low_200_3': 0.005326688628201737, 'ret_from_sma_5': -0.00017189514438520348, 'ret_from_sma_10': -0.0012541556281258082, 'ret_from_sma_20': -0.002249487945332973, 'ret_from_sma_50': -0.004377545688519113, 'ret_from_sma_100': -0.0066616197171471825, 'ret_from_sma_200': -0.006448136272831029, 'ret_from_bb_high_5d_2': -0.01531039722693972, 'ret_from_bb_high_5d_3': -0.020403412071141602, 'ret_from_bb_high_10d_2': -0.019291792747970327, 'ret_from_bb_high_10d_3': -0.031565128244269935, 'ret_from_bb_high_20d_2': -0.02336921391671165, 'ret_from_bb_high_20d_3': -0.04276026043539982, 'ret_from_bb_high_50d_2': -0.021574458108063688, 'ret_from_bb_high_50d_3': -0.03904606186674631, 'ret_from_bb_high_100d_2': -0.0851050010041492, 'ret_from_bb_high_100d_3': -0.1176266697045456, 'ret_from_bb_high_200d_2': -0.06510115192100141, 'ret_from_bb_high_200d_3': -0.0933863059018023, 'ret_from_bb_low_5d_2': 0.005325082458333519, 'ret_from_bb_low_5d_3': 0.010551180574124963, 'ret_from_bb_low_10d_2': 0.031365754119393685, 'ret_from_bb_low_10d_3': 0.04444151643584249, 'ret_from_bb_low_20d_2': 0.05818916241915151, 'ret_from_bb_low_20d_3': 0.0796622050186766, 'ret_from_bb_low_50d_2': 0.051534551687366204, 'ret_from_bb_low_50d_3': 0.0706785870632407, 'ret_from_bb_low_100d_2': 0.05671794206134795, 'ret_from_bb_low_100d_3': 0.09555560326601586, 'ret_from_bb_low_200d_2': 0.05679071153681914, 'ret_from_bb_low_200d_3': 0.08973546437072244, 'ret_from_sma_5d': -0.005045884317658178, 'ret_from_sma_10d': 0.005716241596538829, 'ret_from_sma_20d': 0.016578733503321175, 'ret_from_sma_50d': 0.014312079615453221, 'ret_from_sma_100d': -0.016705643591956587, 'ret_from_sma_200d': -0.00601127489208686, 'ret_from_high': -0.0003437607459089165, 'ret_from_low': 0.00017192469740567873, 'ret_from_open': -0.0003437607459089165, 'close_back': -0.0003437607459089165, 'close_velocity_back': -0.000687521491817833, 'open_back': 0.00017186560152282482, 'high_back': -0.00017183606881321367, 'low_back': -0.00017192469740567873, 'volume_back': 6.979882414270833e-07, 'rsi_14': 39.96479237254396, 'rsi_28': 41.55467022890116, 'rsi_42': 42.9440653232285, 'rsi_14d': 50.81040191574517, 'rsi_28d': 50.19144500052565, 'rsi_42d': 50.01069381889139, 'relative_time_idx': 0.0}
        assert_map_close(trader.current_data_row, expected_data_row1)

        utc_time2 = time_range[1]
        row2 = trader.on_interval(utc_time2)
        expected_row2 = {
            'ticker': 'ES', 'time_idx': 27889, 'day_of_week': 3.0, 'hour_of_day': 19.0, 'year': 2010.0, 'month': 7.0, 'day_of_month': 29.0, 'y_close_cum_max': 0.0037742366548627615, 'y_close_cum_min': -0.25087326765060425, 'y_close_cum': -0.25087326765060425, 'close_back_cumsum': 0, 'close_back': -0.0005157741023822382, 'dm_str': '20100729-233000', 'decoder_time_idx': 27889, 'y_hat_cum_max': 0.0001678663247730583, 'y_hat_cum_min': -0.005132011137902737, 'y_hat_cum': -0.004107004497200251, 'error_cum_max': -0.0036, 'error_cum_min': 0.2457, 'rmse': 0, 'mae': 0, 'error': 0.246766263153404, 'last_position': -5.0, 'new_position': -5.0, 'delta_position': 0.0, 'px': 954.5, 'pnl_delta': -1.25
        }
        logging.error(f"row2:{row2}")
        assert_map_close(row2, expected_row2)
        expected_pnl2 = {
            "ticker": "ES",
            "px": 954.5,
            "last_px": 954.25,
            "pos": -5.0,
            "pnl": -1.25,
        }
        logging.error(f"trader.pnl_df.iloc[-1]:{trader.pnl_df.iloc[-1]}")
        assert_map_close(trader.pnl_df.iloc[-1], expected_pnl2)

        expected_data_row2 = {
            'new_idx': 'ES_1280444400', 'open': 954.0, 'high': 954.75, 'low': 954.0, 'close': 954.5, 'volume': 1775, 'dv': 1693735.25, 'month': 7.0, 'year': 2010.0, 'hour_of_day': 19.0, 'day_of_week': 3.0, 'day_of_month': 29.0, 'time_idx': 27888, 'ticker': 'ES', 'timestamp': 1280444400.0, 'week_of_year': 30.0, 'month_of_year': 7.0, 'weekly_close_time': 1280520000.0, 'last_weekly_close_time': 1279915200.0, 'monthly_close_time': 1280520000.0, 'last_monthly_close_time': 1277928000.0, 'option_expiration_time': 1282334400.0, 'last_option_expiration_time': 1279310400.0, 'time_to_low_1d_ff_shift_1d': 48600.0, 'time_to_low_5d_ff_shift_5d': 48600.0, 'time_to_low_11d_ff_shift_11d': 1173600.0, 'time_to_low_21d_ff_shift_21d': 2298600.0, 'time_to_high_1d_ff_shift_1d': 261000.0, 'time_to_high_5d_ff_shift_5d': 559800.0, 'time_to_high_11d_ff_shift_11d': 559800.0, 'time_to_high_21d_ff_shift_21d': 559800.0, 'time_to_last_macro_event_imp1': -30600.0, 'time_to_last_macro_event_imp2': -104400.0, 'time_to_last_macro_event_imp3': -37800.0, 'time_to_next_macro_event_imp1': 54000.0, 'time_to_next_macro_event_imp2': 48600.0, 'time_to_next_macro_event_imp3': 48600.0, 'time_to_low_1d_ff': -27000.0, 'time_to_low_5d_ff': -817200.0, 'time_to_low_11d_ff': -2068200.0, 'time_to_low_21d_ff': -2068200.0, 'time_to_low_51d_ff': -2068200.0, 'time_to_low_101d_ff': -2068200.0, 'time_to_low_201d_ff': -44074800.0, 'time_to_high_1d_ff': -37800.0, 'time_to_high_5d_ff': -208800.0, 'time_to_high_11d_ff': -208800.0, 'time_to_high_21d_ff': -208800.0, 'time_to_high_51d_ff': -8179200.0, 'time_to_high_101d_ff': -8179200.0, 'time_to_high_201d_ff': -8179200.0, 'time_to_low_5_ff': -1800.0, 'time_to_low_11_ff': -1800.0, 'time_to_low_21_ff': -27000.0, 'time_to_low_51_ff': -27000.0, 'time_to_low_101_ff': -27000.0, 'time_to_low_201_ff': -817200.0, 'time_to_high_5_ff': -14400.0, 'time_to_high_11_ff': -37800.0, 'time_to_high_21_ff': -37800.0, 'time_to_high_51_ff': -208800.0, 'time_to_high_101_ff': -208800.0, 'time_to_high_201_ff': -208800.0, 'time_to_weekly_close': 75600.0, 'time_to_monthly_close': 75600.0, 'time_to_option_expiration': 1890000.0, 'time_to_new_york_open': 52200.0, 'time_to_new_york_last_open': -34200.0, 'time_to_new_york_last_close': -10800.0, 'time_to_new_york_close': 75600.0, 'time_to_london_open': 28800.0, 'time_to_london_last_open': -57600.0, 'time_to_london_close': 59400.0, 'time_to_london_last_close': -57600.0, 'ret_from_kc_10_05_high': -0.0015324811564632057, 'ret_from_kc_10_10_high': -0.0024573336225479636, 'ret_from_kc_10_15_high': -0.003381331526830955, 'ret_from_kc_10_20_high': -0.004304476447082095, 'ret_from_kc_10d_05_high': -0.004551667281189609, 'ret_from_kc_10d_10_high': -0.011963389099112653, 'ret_from_kc_10d_15_high': -0.01932058120797553, 'ret_from_kc_10d_20_high': -0.026624040125916792, 'ret_from_kc_10w_05_high': -0.009409058086449207, 'ret_from_kc_10w_10_high': -0.027206455306203026, 'ret_from_kc_10w_15_high': -0.04469263595216599, 'ret_from_kc_10w_20_high': -0.06187829749027696, 'ret_from_kc_10m_05_high': -0.016065794522627463, 'ret_from_kc_10m_10_high': -0.049593298186477064, 'ret_from_kc_10m_15_high': -0.08203307841884122, 'ret_from_kc_10m_20_high': -0.11345350048540315, 'ret_from_kc_10_05_low': 0.00031979379411062325, 'ret_from_kc_10_10_low': 0.0012472194561103933, 'ret_from_kc_10_15_low': 0.0021755060349679667, 'ret_from_kc_10_20_low': 0.0031046551305218273, 'ret_from_kc_10d_05_low': 0.010438641307390029, 'ret_from_kc_10d_10_low': 0.018018912498564355, 'ret_from_kc_10d_15_low': 0.02565708337575323, 'ret_from_kc_10d_20_low': 0.033354045251011044, 'ret_from_kc_10w_05_low': 0.0271651266561328, 'ret_from_kc_10w_10_low': 0.045966392665998335, 'ret_from_kc_10w_15_low': 0.06512793066474387, 'ret_from_kc_10w_20_low': 0.08466381798831346, 'ret_from_kc_10m_05_low': 0.05456245223486622, 'ret_from_kc_10m_10_low': 0.09183979518175, 'ret_from_kc_10m_15_low': 0.13056072514253447, 'ret_from_kc_10m_20_low': 0.17084156959574948, 'ret_from_kc_10_05_mid': -0.0006067725464262708, 'ret_from_kc_10d_05_mid': 0.002915398607139963, 'ret_from_kc_10w_05_mid': 0.008710834729915184, 'ret_from_kc_10m_05_mid': 0.018624914760260403, 'ret_from_close_cumsum_high_5d': 0.013656750320074629, 'ret_from_close_cumsum_high_11d': 0.013656750320074629, 'ret_from_close_cumsum_high_21d': 0.013656750320074629, 'ret_from_close_cumsum_high_51d': 0.021593970069734958, 'ret_from_close_cumsum_high_101d': 0.07577627479777593, 'ret_from_close_cumsum_high_201d': 0.07577627479777593, 'ret_from_close_cumsum_low_5d': -0.008111184344181233, 'ret_from_close_cumsum_low_11d': -0.03160455097357229, 'ret_from_close_cumsum_low_21d': -0.06570799122579896, 'ret_from_close_cumsum_low_51d': -0.06570799122579896, 'ret_from_close_cumsum_low_101d': -0.06570799122579896, 'ret_from_close_cumsum_low_201d': -0.06570799122579896, 'ret_from_high_1d': -0.009238731239204157, 'ret_from_high_1d_shift_1d': -0.004801106616044493, 'ret_from_high_5d': -0.013656750320074629, 'ret_from_high_5d_shift_5d': -0.020584208960713113, 'ret_from_high_11d': -0.013656750320074629, 'ret_from_high_11d_shift_11d': -0.020584208960713113, 'ret_from_high_21d': -0.013656750320074629, 'ret_from_high_21d_shift_21d': -0.020584208960713113, 'ret_from_high_51d': -0.021593970069734958, 'ret_from_high_101d': -0.07577627479777593, 'ret_from_high_201d': -0.07577627479777593, 'ret_from_low_1d': 0.0029262435890826666, 'ret_from_low_1d_shift_1d': 0.007591478832266851, 'ret_from_low_5d': 0.008111184344180344, 'ret_from_low_5d_shift_5d': 0.007591478832266851, 'ret_from_low_11d': 0.03160455097357229, 'ret_from_low_11d_shift_11d': 0.017862262826236375, 'ret_from_low_21d': 0.06570799122579896, 'ret_from_low_21d_shift_21d': 0.038725820163787006, 'ret_from_low_51d': 0.06570799122579896, 'ret_from_low_101d': 0.06570799122579896, 'ret_from_low_201d': 0.06570799122579896, 'ret_from_high_5d_bf': -0.013656750320074629, 'ret_from_high_11d_bf': -0.013656750320074629, 'ret_from_high_21d_bf': -0.013656750320074629, 'ret_from_high_51d_bf': -0.021593970069734958, 'ret_from_low_5d_bf': 0.008111184344180344, 'ret_from_low_11d_bf': 0.03160455097357229, 'ret_from_low_21d_bf': 0.06570799122579896, 'ret_from_low_51d_bf': 0.06570799122579896, 'ret_from_close_cumsum_high_5': 0.00017186560152282482, 'ret_from_close_cumsum_high_11': 0.004116643892539074, 'ret_from_close_cumsum_high_21': 0.009238731239204157, 'ret_from_close_cumsum_high_51': 0.009238731239204157, 'ret_from_close_cumsum_high_101': 0.011789969973113656, 'ret_from_close_cumsum_high_201': 0.013656750320074629, 'ret_from_close_cumsum_low_5': -0.00017189514438609166, 'ret_from_close_cumsum_low_11': -0.00017189514438609166, 'ret_from_close_cumsum_low_21': -0.0029262435890826666, 'ret_from_close_cumsum_low_51': -0.0029262435890826666, 'ret_from_close_cumsum_low_101': -0.0029262435890826666, 'ret_from_close_cumsum_low_201': -0.004133660725851307, 'ret_from_high_5': -0.00017186560152282482, 'ret_velocity_from_high_5': 1.1935111216862834e-08, 'ret_from_high_11': -0.004116643892539074, 'ret_velocity_from_high_11': 1.0890592308304427e-07, 'ret_from_high_21': -0.009238731239204157, 'ret_velocity_from_high_21': 2.444108793440253e-07, 'ret_from_high_51': -0.009238731239204157, 'ret_velocity_from_high_51': 4.424679712262527e-08, 'ret_from_high_101': -0.011789969973114545, 'ret_velocity_from_high_101': 5.646537343445663e-08, 'ret_from_high_201': -0.013656750320074629, 'ret_velocity_from_high_201': 6.540589233752217e-08, 'ret_from_low_5': 0.00017189514438520348, 'ret_velocity_from_low_5': -9.549730243622416e-08, 'ret_from_low_11': 0.00017189514438520348, 'ret_velocity_from_low_11': -9.549730243622416e-08, 'ret_from_low_21': 0.0029262435890826666, 'ret_velocity_from_low_21': -1.083793921882469e-07, 'ret_from_low_51': 0.0029262435890826666, 'ret_velocity_from_low_51': -1.083793921882469e-07, 'ret_from_low_101': 0.0029262435890826666, 'ret_velocity_from_low_101': -1.083793921882469e-07, 'ret_from_low_201': 0.004133660725851307, 'ret_velocity_from_low_201': -5.058321984644282e-09, 'ret_from_vwap_since_last_macro_event_imp1': -0.00013213141385026717, 'ret_from_vwap_pre_macro_event_imp1': -0.006844723439118461, 'ret_from_vwap_post_macro_event_imp1': -0.002284510380122562, 'ret_from_vwap_around_macro_event_imp1': -0.006689559896679853, 'ret_from_vwap_since_last_macro_event_imp2': -0.0017788318659235358, 'ret_from_vwap_pre_macro_event_imp2': -0.0004169970318388394, 'ret_from_vwap_post_macro_event_imp2': -0.0029853403369539677, 'ret_from_vwap_around_macro_event_imp2': -0.0019914117655774888, 'ret_from_vwap_since_last_macro_event_imp3': -0.002211209120053681, 'ret_from_vwap_pre_macro_event_imp3': -0.008123833971894534, 'ret_from_vwap_post_macro_event_imp3': -0.008998046710314789, 'ret_from_vwap_around_macro_event_imp3': -0.008363267991478018, 'ret_from_vwap_since_new_york_open': -0.0009080816193067776, 'ret_from_vwap_since_london_open': -0.0026650378594137436, 'ret_from_vwap_pre_new_york_open': -0.009532673530128655, 'ret_from_vwap_post_new_york_open': -0.0067780628619651395, 'daily_returns': 0.000171909919202351, 'daily_returns_5': 0.0, 'daily_returns_10': -0.0003436426116838476, 'daily_returns_20': -0.009196185286103553, 'daily_vol': 0.0014534863292368966, 'daily_vol_5': 0.0037465983727046235, 'daily_vol_10': 0.003921926177868169, 'daily_vol_20': 0.004682062864057271, 'daily_skew': 0.42673581001975286, 'daily_skew_5': 0.435287857050142, 'daily_skew_10': 0.30718155419928656, 'daily_skew_20': -0.10703370838524756, 'daily_kurt': 30.8210747729183, 'daily_kurt_5': 19.036350023322406, 'daily_kurt_10': 13.088241740917828, 'daily_kurt_20': 9.139123337543898, 'macd_8_24': -1.42770423247386, 'macd_16_48': -1.0333375865397194, 'macd_32_96': 0.1311275078949337, 'macd_8_24_day': 0.1746039023923912, 'macd_16_48_day': -0.30791290545342825, 'macd_32_96_day': -0.5789572990273537, 'daily_returns_1d': -0.004108182129407778, 'daily_returns_5d': 0.004835924006908465, 'daily_returns_10d': 0.0039689387402932486, 'daily_returns_20d': 0.053222302679218014, 'daily_vol_1d': 0.003402201618420583, 'daily_vol_5d': 0.010127210941209623, 'daily_vol_10d': 0.0053608249478397, 'daily_vol_20d': 0.006182313641693002, 'daily_vol_diff_1_20d': -0.0027801120232724187, 'daily_skew_1d': -0.01573677247736883, 'daily_skew_5d': -0.5692118036379152, 'daily_skew_10d': -0.9734839954678443, 'daily_skew_20d': -0.8847774412673657, 'daily_kurt_1d': 6.550524439406857, 'daily_kurt_5d': 3.9543751759914927, 'daily_kurt_10d': 3.184080102785658, 'daily_kurt_20d': 1.9148399816013142, 'ret_from_last_daily_close_0': 0.0, 'ret_from_last_daily_close_1': -0.0039454549851623, 'ret_from_last_daily_close_2': -0.009749499957212748, 'ret_from_last_daily_close_3': -0.008727701503187468, 'ret_from_last_daily_close_4': -0.002917705665509196, 'ret_from_last_daily_close_5': 0.005688199427369867, 'ret_from_last_daily_close_6': 0.022949546844201585, 'ret_from_last_daily_close_7': 0.011235102191853308, 'ret_from_last_daily_close_8': 0.022597867572070385, 'ret_from_last_daily_close_9': 0.023301349838155794, 'ret_from_last_daily_close_10': 0.004478904989595023, 'ret_from_last_daily_close_11': 0.003961083281295075, 'ret_from_last_daily_close_12': 0.004996994976142588, 'ret_from_last_daily_close_13': 0.014194456775690867, 'ret_from_last_daily_close_14': 0.017337466172890004, 'ret_from_last_daily_close_15': 0.020665839220147753, 'ret_from_last_daily_close_16': 0.026120238244575766, 'ret_from_last_daily_close_17': 0.051311387221884, 'ret_from_last_daily_close_18': 0.05839266964942613, 'ret_from_last_daily_close_19': 0.05275987561564577, 'ret_from_last_weekly_close_0': -0.002917705665509196, 'ret_from_last_weekly_close_1': 0.023301349838155794, 'ret_from_last_weekly_close_2': 0.017337466172890004, 'ret_from_last_weekly_close_3': 0.05839266964942613, 'ret_from_last_weekly_close_4': 0.015241029346361401, 'ret_from_last_weekly_close_5': -0.009238731239204157, 'ret_from_last_weekly_close_6': 0.008111184344180344, 'ret_from_last_weekly_close_7': 0.024357502022230193, 'ret_from_last_weekly_close_8': 0.009324881935734552, 'ret_from_last_weekly_close_9': 0.011408939654264039, 'ret_from_last_weekly_close_10': -0.02327464273425317, 'ret_from_last_weekly_close_11': -0.004458933815443267, 'ret_from_last_weekly_close_12': -0.0566330858560633, 'ret_from_last_weekly_close_13': -0.07402202827502169, 'ret_from_last_weekly_close_14': -0.059228383338749246, 'ret_from_last_weekly_close_15': -0.061332114189867504, 'ret_from_last_weekly_close_16': -0.04880653359461995, 'ret_from_last_weekly_close_17': -0.04190768888715102, 'ret_from_last_weekly_close_18': -0.03728187525275395, 'ret_from_last_weekly_close_19': -0.030802909155045022, 'ret_from_last_monthly_close_0': 0.05094959271721411, 'ret_from_last_monthly_close_1': 0.009324881935734552, 'ret_from_last_monthly_close_2': -0.0566330858560633, 'ret_from_last_monthly_close_3': -0.04487016636648011, 'ret_from_last_monthly_close_4': 0.0003438198417917704, 'ret_from_last_monthly_close_5': 0.0257674423333496, 'ret_from_last_monthly_close_6': -0.005143162374467103, 'ret_from_last_monthly_close_7': 0.011930633431855853, 'ret_from_last_monthly_close_8': 0.05511815335259396, 'ret_from_last_monthly_close_9': 0.039440744233559144, 'ret_from_last_monthly_close_10': 0.0668099197119556, 'ret_from_last_monthly_close_11': 0.0957055828196971, 'ret_from_last_monthly_close_12': 0.14653110612787046, 'ret_from_last_monthly_close_13': 0.14553657596136205, 'ret_from_last_monthly_close_14': 0.19171583739032272, 'ret_from_last_monthly_close_15': 0.255768669012709, 'ret_from_last_monthly_close_16': 0.3112180263965847, 'ret_from_last_monthly_close_17': 0.22775195363849843, 'ret_from_last_monthly_close_18': 0.17212960154303403, 'ret_from_last_monthly_close_19': 0.17029380296524366, 'ret_to_next_new_york_close': 0.0, 'ret_to_next_weekly_close': 0.0, 'ret_to_next_monthly_close': 0.0, 'ret_from_vwap_around_new_york_open': -0.008227149695485991, 'ret_from_vwap_pre_new_york_close': 0.0003134479804902668, 'ret_from_vwap_post_new_york_close': -4.801458179848339e-05, 'ret_from_vwap_around_new_york_close': 0.00030226528818655396, 'ret_from_vwap_pre_london_open': -0.006954784325760244, 'ret_from_vwap_post_london_open': -0.006199189865877308, 'ret_from_vwap_around_london_open': -0.006692059600132083, 'ret_from_vwap_pre_london_close': -0.006954784325760244, 'ret_from_vwap_post_london_close': -0.006199189865877308, 'ret_from_vwap_around_london_close': -0.006692059600132083, 'ret_from_bb_high_5_2': -0.00030742169671515995, 'ret_from_bb_high_5_3': -0.00046109711179642687, 'ret_from_bb_high_10_2': -0.004169499238655838, 'ret_from_bb_high_10_3': -0.005726641850238856, 'ret_from_bb_high_20_2': -0.008335019421823908, 'ret_from_bb_high_20_3': -0.011678481161947474, 'ret_from_bb_high_50_2': -0.010571888850395617, 'ret_from_bb_high_50_3': -0.013772084968990406, 'ret_from_bb_high_100_2': -0.013579234949076202, 'ret_from_bb_high_100_3': -0.017159298293804248, 'ret_from_bb_high_200_2': -0.013986618565698272, 'ret_from_bb_high_200_3': -0.017809918940706382, 'ret_from_bb_low_5_2': 0.00030751623387814675, 'ret_from_bb_low_5_3': 0.0004613098204266919, 'ret_from_bb_low_10_2': 0.0020834320027356412, 'ret_from_bb_low_10_3': 0.003652793212872929, 'ret_from_bb_low_20_2': 0.0051517489265728855, 'ret_from_bb_low_20_3': 0.008552054681532084, 'ret_from_bb_low_50_2': 0.002332302095248373, 'ret_from_bb_low_50_3': 0.0055845372099305735, 'ret_from_bb_low_100_2': 0.0008705802993365097, 'ret_from_bb_low_100_3': 0.004515896021005439, 'ret_from_bb_low_200_2': 0.001454457664297415, 'ret_from_bb_low_200_3': 0.005352270681696858, 'ret_from_sma_5': 0.0, 'ret_from_sma_10': -0.0010479210036367093, 'ret_from_sma_20': -0.0016143716903700422, 'ret_from_sma_50': -0.004140608001152124, 'ret_from_sma_100': -0.00638042674289796, 'ret_from_sma_200': -0.0062958835090176635, 'ret_from_bb_high_5d_2': -0.015100877382303146, 'ret_from_bb_high_5d_3': -0.020165112689578102, 'ret_from_bb_high_10d_2': -0.019133539313176406, 'ret_from_bb_high_10d_3': -0.03140928185663405, 'ret_from_bb_high_20d_2': -0.023204452920777108, 'ret_from_bb_high_20d_3': -0.04257254249183795, 'ret_from_bb_high_50d_2': -0.02141547676900668, 'ret_from_bb_high_50d_3': -0.038888385910571976, 'ret_from_bb_high_100d_2': -0.0849275224626318, 'ret_from_bb_high_100d_3': -0.11744960783296232, 'ret_from_bb_high_200d_2': -0.0649293078642934, 'ret_from_bb_high_200d_3': -0.09321359170884858, 'ret_from_bb_low_5d_2': 0.005416492583117716, 'ret_from_bb_low_5d_3': 0.010612291931423101, 'ret_from_bb_low_10d_2': 0.03153426118967406, 'ret_from_bb_low_10d_3': 0.04461275562585154, 'ret_from_bb_low_20d_2': 0.0582523479381889, 'ret_from_bb_low_20d_3': 0.07969724259318589, 'ret_from_bb_low_50d_2': 0.051699249630178024, 'ret_from_bb_low_50d_3': 0.07084485227911408, 'ret_from_bb_low_100d_2': 0.05689740473038274, 'ret_from_bb_low_100d_3': 0.09573566018622959, 'ret_from_bb_low_200d_2': 0.0569585110712314, 'ret_from_bb_low_200d_3': 0.08990208344643769, 'ret_from_sma_5d': -0.004894811785439934, 'ret_from_sma_10d': 0.00587949200769966, 'ret_from_sma_20d': 0.01669477540872588, 'ret_from_sma_50d': 0.014473814815011643, 'ret_from_sma_100d': -0.0165272432181931, 'ret_from_sma_200d': -0.005841330002346545, 'ret_from_high': -0.00017186560152282482, 'ret_from_low': 0.0003438198417917704, 'ret_from_open': 0.0003438198417917704, 'close_back': 0.00017189514438609166, 'close_velocity_back': 0.0005156558902950081, 'open_back': -0.0005156854433145952, 'high_back': 0.0, 'low_back': 0.0, 'volume_back': 1.3674700234389547e-06, 'rsi_14': 40.73035660813354, 'rsi_28': 41.9484501073002, 'rsi_42': 43.21535388224556, 'rsi_14d': 50.82458183718323, 'rsi_28d': 50.19833311718407, 'rsi_42d': 50.01535989474981, 'relative_time_idx': 0.0}
        logging.error(f"trader.current_data_row:{trader.current_data_row.to_dict()}")
        assert_map_close(trader.current_data_row, expected_data_row2)


def test_on_interval_no_future():
    pd.set_option("display.max_columns", None)
    pd.set_option("display.max_rows", None)
    with initialize(version_base=None, config_path="../../../conf"):
        cfg = compose(
            config_name="test",
            overrides=[
                "job.test_start_date=2010-07-30",
                "job.test_end_date=2010-07-30",
            ],
            return_hydra_config=True,
        )
        env_mgr = EnvMgr(cfg)
        md_mgr = market_data_mgr.MarketDataMgr(env_mgr)
        market_cal = md_mgr.market_cal
        wandb_logger = None
        data_module = md_mgr.data_module()
        model = model_utils.get_patch_tft_supervised_model(
            cfg, data_module, env_mgr.heads
        )
        train_dataset = data_module.training
        train_data = data_module.train_data
        future_data = data_module.test_data
        ray.shutdown()
        ray.init(object_store_memory=30*1024*1024*1024,
                 storage=f"{cfg.dataset.base_dir}/cache")

        trader = Trader(
            md_mgr,
            model,
            wandb_logger,
            env_mgr.target_size,
            future_data,
            train_data,
            train_dataset,
            cfg,
            market_cal,
        )
        first_train_data_row = train_data.iloc[0]
        logging.info(f"first_train_data_row:{first_train_data_row}")
        last_train_data_row = train_data.iloc[-1]
        logging.info(f"last_train_data_row:{last_train_data_row}")
        test_date = cfg.job.test_start_date
        schedule = market_cal.schedule(start_date=test_date, end_date=test_date)
        time_range = mcal.date_range(
            schedule, frequency=f"{cfg.job.time_interval_minutes}min"
        )
        logging.info(f"sod {test_date}, schedule:{time_range}")
        utc_time1 = time_range[-3]
        row1 = trader.on_interval(utc_time1)
        logging.error(f"row1:{row1}")
        expected_row1 = {
            'ticker': 'ES', 'time_idx': 27931, 'day_of_week': 4, 'hour_of_day': 21, 'year': 2010, 'month': 7, 'day_of_month': 30, 'y_close_cum_max': -0.06246223300695419, 'y_close_cum_min': -0.39131617546081543, 'y_close_cum': -0.39131617546081543, 'close_back_cumsum': 0, 'close_back': -0.06246223179306565, 'dm_str': '20100730-210000', 'decoder_time_idx': 27931, 'y_hat_cum_max': 3.036921043531038e-07, 'y_hat_cum_min': -0.0029780606273561716, 'y_hat_cum': -0.0029780606273561716, 'error_cum_max': 0.0625, 'error_cum_min': 0.3883, 'rmse': 0, 'mae': 0, 'error': 0.38833811483345926, 'last_position': 0, 'new_position': -5.0, 'delta_position': -5.0, 'px': 958.0, 'pnl_delta': 0.0}

        assert_map_close(row1, expected_row1)
        expected_pnl1 = {
            "ticker": "ES",
            "px": 958.0,
            "last_px": 954.75,
            "pos": -5.0,
            "pnl": 0.0,
        }
        logging.error(f"actual_pnl1:{trader.pnl_df.iloc[-1]}")
        assert_map_close(trader.pnl_df.iloc[-1], expected_pnl1)

        expected_data_row1 = {
            'new_idx': 'ES_1280520000', 'open': 955.5, 'high': 958.25, 'low': 954.75, 'close': 958.0, 'volume': 101481, 'dv': 97116725.25, 'month': 7.0, 'year': 2010.0, 'hour_of_day': 16.0, 'day_of_week': 4.0, 'day_of_month': 30.0, 'time_idx': 27930, 'ticker': 'ES', 'timestamp': 1280520000.0, 'week_of_year': 30.0, 'month_of_year': 7.0, 'weekly_close_time': 1280520000.0, 'last_weekly_close_time': 1280520000.0, 'monthly_close_time': 1280520000.0, 'last_monthly_close_time': 1280520000.0, 'option_expiration_time': 1282334400.0, 'last_option_expiration_time': 1279310400.0, 'time_to_low_1d_ff_shift_1d': -27000.0, 'time_to_low_5d_ff_shift_5d': -27000.0, 'time_to_low_11d_ff_shift_11d': 1400400.0, 'time_to_low_21d_ff_shift_21d': 2223000.0, 'time_to_high_1d_ff_shift_1d': 255600.0, 'time_to_high_5d_ff_shift_5d': 484200.0, 'time_to_high_11d_ff_shift_11d': 484200.0, 'time_to_high_21d_ff_shift_21d': 484200.0, 'time_to_last_macro_event_imp1': -21600.0, 'time_to_last_macro_event_imp2': -21600.0, 'time_to_last_macro_event_imp3': -27000.0, 'time_to_next_macro_event_imp1': 237600.0, 'time_to_next_macro_event_imp2': 259200.0, 'time_to_next_macro_event_imp3': 237600.0, 'time_to_low_1d_ff': -27000.0, 'time_to_low_5d_ff': -27000.0, 'time_to_low_11d_ff': -2143800.0, 'time_to_low_21d_ff': -2143800.0, 'time_to_low_51d_ff': -2143800.0, 'time_to_low_101d_ff': -2143800.0, 'time_to_low_201d_ff': -44150400.0, 'time_to_high_1d_ff': -3600.0, 'time_to_high_5d_ff': -284400.0, 'time_to_high_11d_ff': -284400.0, 'time_to_high_21d_ff': -284400.0, 'time_to_high_51d_ff': -8254800.0, 'time_to_high_101d_ff': -8254800.0, 'time_to_high_201d_ff': -8254800.0, 'time_to_low_5_ff': -9000.0, 'time_to_low_11_ff': -27000.0, 'time_to_low_21_ff': -27000.0, 'time_to_low_51_ff': -27000.0, 'time_to_low_101_ff': -27000.0, 'time_to_low_201_ff': -27000.0, 'time_to_high_5_ff': -3600.0, 'time_to_high_11_ff': -3600.0, 'time_to_high_21_ff': -3600.0, 'time_to_high_51_ff': -284400.0, 'time_to_high_101_ff': -284400.0, 'time_to_high_201_ff': -284400.0, 'time_to_weekly_close': 0.0, 'time_to_monthly_close': 0.0, 'time_to_option_expiration': 1814400.0, 'time_to_new_york_open': 235800.0, 'time_to_new_york_last_open': -23400.0, 'time_to_new_york_last_close': 0.0, 'time_to_new_york_close': 0.0, 'time_to_london_open': 212400.0, 'time_to_london_last_open': -46800.0, 'time_to_london_close': 243000.0, 'time_to_london_last_close': -46800.0, 'ret_from_kc_10_05_high': 0.0005731303725671211, 'ret_from_kc_10_10_high': -0.0010007140069729914, 'ret_from_kc_10_15_high': -0.002572085292138482, 'ret_from_kc_10_20_high': -0.004140991243036574, 'ret_from_kc_10d_05_high': -0.003050722440924858, 'ret_from_kc_10d_10_high': -0.010396747260755568, 'ret_from_kc_10d_15_high': -0.017689201293115353, 'ret_from_kc_10d_20_high': -0.024928860213314863, 'ret_from_kc_10w_05_high': -0.0084049398816477, 'ret_from_kc_10w_10_high': -0.025593540444412533, 'ret_from_kc_10w_15_high': -0.042491678629237306, 'ret_from_kc_10w_20_high': -0.05910900830998145, 'ret_from_kc_10m_05_high': -0.017899930769197603, 'ret_from_kc_10m_10_high': -0.05178336329202171, 'ret_from_kc_10m_15_high': -0.08455623564253933, 'ret_from_kc_10m_20_high': -0.11628904262822726, 'ret_from_kc_10_05_low': 0.0037282696389251413, 'ret_from_kc_10_10_low': 0.005309580230373534, 'ret_from_kc_10_15_low': 0.006893395325930918, 'ret_from_kc_10_20_low': 0.008479722871527429, 'ret_from_kc_10d_05_low': 0.011805228881605068, 'ret_from_kc_10d_10_low': 0.019316794914182367, 'ret_from_kc_10d_15_low': 0.026885211879893234, 'ret_from_kc_10d_20_low': 0.034511346892831085, 'ret_from_kc_10w_05_low': 0.026884832713029105, 'ret_from_kc_10w_10_low': 0.045007992815762066, 'ret_from_kc_10w_15_low': 0.06346567375012757, 'ret_from_kc_10w_20_low': 0.08227045742109151, 'ret_from_kc_10m_05_low': 0.05351876960419055, 'ret_from_kc_10m_10_low': 0.0912366435862948, 'ret_from_kc_10m_15_low': 0.13043310698505817, 'ret_from_kc_10m_20_low': 0.17122883160149982, 'ret_from_kc_10_05_mid': 0.0021494556432886114, 'ret_from_kc_10d_05_mid': 0.004349666062812396, 'ret_from_kc_10w_05_mid': 0.009084283486617828, 'ret_from_kc_10m_05_mid': 0.017171976028321545, 'ret_from_close_cumsum_high_5d': 0.011253315686727383, 'ret_from_close_cumsum_high_11d': 0.011253315686727383, 'ret_from_close_cumsum_high_21d': 0.011253315686727383, 'ret_from_close_cumsum_high_51d': 0.019190535436387712, 'ret_from_close_cumsum_high_101d': 0.07337284016442869, 'ret_from_close_cumsum_high_201d': 0.07337284016442869, 'ret_from_close_cumsum_low_5d': -0.009994913465614097, 'ret_from_close_cumsum_low_11d': -0.03400798560691953, 'ret_from_close_cumsum_low_21d': -0.0681114258591462, 'ret_from_close_cumsum_low_51d': -0.0681114258591462, 'ret_from_close_cumsum_low_101d': -0.0681114258591462, 'ret_from_close_cumsum_low_201d': -0.0681114258591462, 'ret_from_high_1d': -0.0013708021337786036, 'ret_from_high_1d_shift_1d': -0.01582069231483807, 'ret_from_high_5d': -0.011253315686727383, 'ret_from_high_5d_shift_5d': -0.018180774327365867, 'ret_from_high_11d': -0.011253315686727383, 'ret_from_high_11d_shift_11d': -0.018180774327365867, 'ret_from_high_21d': -0.011253315686727383, 'ret_from_high_21d_shift_21d': -0.018180774327365867, 'ret_from_high_51d': -0.019190535436387712, 'ret_from_high_101d': -0.07337284016442869, 'ret_from_high_201d': -0.07337284016442869, 'ret_from_low_1d': 0.009994913465614097, 'ret_from_low_1d_shift_1d': -0.001884368865942676, 'ret_from_low_5d': 0.009994913465614097, 'ret_from_low_5d_shift_5d': -0.001884368865942676, 'ret_from_low_11d': 0.03400798560691953, 'ret_from_low_11d_shift_11d': 0.021666503151785754, 'ret_from_low_21d': 0.0681114258591462, 'ret_from_low_21d_shift_21d': 0.04112925479713425, 'ret_from_low_51d': 0.0681114258591462, 'ret_from_low_101d': 0.0681114258591462, 'ret_from_low_201d': 0.0681114258591462, 'ret_from_high_5d_bf': -0.011253315686727383, 'ret_from_high_11d_bf': -0.011253315686727383, 'ret_from_high_21d_bf': -0.011253315686727383, 'ret_from_high_51d_bf': -0.019190535436387712, 'ret_from_low_5d_bf': 0.009994913465614097, 'ret_from_low_11d_bf': 0.03400798560691953, 'ret_from_low_21d_bf': 0.0681114258591462, 'ret_from_low_51d_bf': 0.0681114258591462, 'ret_from_close_cumsum_high_5': 0.0013708021337786036, 'ret_from_close_cumsum_high_11': 0.0013708021337786036, 'ret_from_close_cumsum_high_21': 0.0013708021337786036, 'ret_from_close_cumsum_high_51': 0.001713209259191828, 'ret_from_close_cumsum_high_101': 0.006835296605856911, 'ret_from_close_cumsum_high_201': 0.011253315686727383, 'ret_from_close_cumsum_low_5': -0.00343524899832115, 'ret_from_close_cumsum_low_11': -0.00636451791464232, 'ret_from_close_cumsum_low_21': -0.009994913465614097, 'ret_from_close_cumsum_low_51': -0.009994913465614097, 'ret_from_close_cumsum_low_101': -0.009994913465614097, 'ret_from_close_cumsum_low_201': -0.009994913465614097, 'ret_from_high_5': -0.0013708021337786036, 'ret_velocity_from_high_5': 3.8077837049405655e-07, 'ret_from_high_11': -0.0013708021337786036, 'ret_velocity_from_high_11': 3.8077837049405655e-07, 'ret_from_high_21': -0.0013708021337786036, 'ret_velocity_from_high_21': 3.8077837049405655e-07, 'ret_from_high_51': -0.001713209259191828, 'ret_velocity_from_high_51': 6.023942542868594e-09, 'ret_from_high_101': -0.006835296605856911, 'ret_velocity_from_high_101': 2.4034094957302782e-08, 'ret_from_high_201': -0.011253315686727383, 'ret_velocity_from_high_201': 3.956862055811316e-08, 'ret_from_low_5': 0.00343524899832115, 'ret_velocity_from_low_5': -3.8169433314679443e-07, 'ret_from_low_11': 0.00636451791464232, 'ret_velocity_from_low_11': -2.3572288572749334e-07, 'ret_from_low_21': 0.009994913465614097, 'ret_velocity_from_low_21': -3.701819802079295e-07, 'ret_from_low_51': 0.009994913465614097, 'ret_velocity_from_low_51': -3.701819802079295e-07, 'ret_from_low_101': 0.009994913465614097, 'ret_velocity_from_low_101': -3.701819802079295e-07, 'ret_from_low_201': 0.009994913465614097, 'ret_velocity_from_low_201': -3.701819802079295e-07, 'ret_from_vwap_since_last_macro_event_imp1': 0.0019683690689582534, 'ret_from_vwap_pre_macro_event_imp1': -0.004441288805771215, 'ret_from_vwap_post_macro_event_imp1': 0.001406489340470607, 'ret_from_vwap_around_macro_event_imp1': -0.0042861252633326075, 'ret_from_vwap_since_last_macro_event_imp2': 0.0019683690689582534, 'ret_from_vwap_pre_macro_event_imp2': 0.001986437601508406, 'ret_from_vwap_post_macro_event_imp2': 0.001406489340470607, 'ret_from_vwap_around_macro_event_imp2': 0.00041202286776975683, 'ret_from_vwap_since_last_macro_event_imp3': 0.0031717718474322254, 'ret_from_vwap_pre_macro_event_imp3': 0.00905113860552742, 'ret_from_vwap_post_macro_event_imp3': 0.009723163721206518, 'ret_from_vwap_around_macro_event_imp3': 0.009253738113948806, 'ret_from_vwap_since_new_york_open': 0.0018822493375409977, 'ret_from_vwap_since_london_open': 0.0037319257619321533, 'ret_from_vwap_pre_new_york_open': 0.00777442562476427, 'ret_from_vwap_post_new_york_open': 0.004058833288103081, 'daily_returns': 0.0015455950540959051, 'daily_returns_5': 0.0063848144952545205, 'daily_returns_10': 0.003095975232198178, 'daily_returns_20': 0.005864091065884702, 'daily_vol': 0.0018192987718937859, 'daily_vol_5': 0.003364702708540622, 'daily_vol_10': 0.003518059570293715, 'daily_vol_20': 0.004139239777884683, 'daily_skew': 0.42639322470339514, 'daily_skew_5': 0.4351124254375699, 'daily_skew_10': 0.30765236916022604, 'daily_skew_20': -0.10603719548263627, 'daily_kurt': 30.834043822669763, 'daily_kurt_5': 19.04168899646999, 'daily_kurt_10': 13.098893578476531, 'daily_kurt_20': 9.147553386216249, 'macd_8_24': 0.14574731347309913, 'macd_16_48': -0.6073307285120481, 'macd_32_96': -0.43809601528415787, 'macd_8_24_day': 0.18741054329469067, 'macd_16_48_day': -0.3160056325748273, 'macd_32_96_day': -0.5987828900066186, 'daily_returns_1d': 0.002234060835194951, 'daily_returns_5d': 0.0, 'daily_returns_10d': 0.02748414376321362, 'daily_returns_20d': 0.0603636363636364, 'daily_vol_1d': 0.00523355439826453, 'daily_vol_5d': 0.00839722907752419, 'daily_vol_10d': 0.009573262109467802, 'daily_vol_20d': 0.005443717023053762, 'daily_vol_diff_1_20d': -0.00021016262478923148, 'daily_skew_1d': -0.014308978440951256, 'daily_skew_5d': -0.5705675884780503, 'daily_skew_10d': -0.9751003956638138, 'daily_skew_20d': -0.8861728222372061, 'daily_kurt_1d': 6.558826259382294, 'daily_kurt_5d': 3.9612325889755944, 'daily_kurt_10d': 3.1933798736547656, 'daily_kurt_20d': 1.9130741099442479, 'ret_from_last_daily_close_0': 0.0, 'ret_from_last_daily_close_1': 0.0024034346333472456, 'ret_from_last_daily_close_2': -0.0015420203518150544, 'ret_from_last_daily_close_3': -0.007346065323865503, 'ret_from_last_daily_close_4': -0.006324266869840223, 'ret_from_last_daily_close_5': -0.0005142710321619504, 'ret_from_last_daily_close_6': 0.008091634060717112, 'ret_from_last_daily_close_7': 0.02535298147754883, 'ret_from_last_daily_close_8': 0.013638536825200553, 'ret_from_last_daily_close_9': 0.02500130220541763, 'ret_from_last_daily_close_10': 0.02570478447150304, 'ret_from_last_daily_close_11': 0.006882339622942268, 'ret_from_last_daily_close_12': 0.00636451791464232, 'ret_from_last_daily_close_13': 0.007400429609489834, 'ret_from_last_daily_close_14': 0.016597891409038112, 'ret_from_last_daily_close_15': 0.01974090080623725, 'ret_from_last_daily_close_16': 0.023069273853494998, 'ret_from_last_daily_close_17': 0.028523672877923012, 'ret_from_last_daily_close_18': 0.05371482185523124, 'ret_from_last_daily_close_19': 0.06079610428277338, 'ret_from_last_weekly_close_0': 0.0, 'ret_from_last_weekly_close_1': -0.0005142710321619504, 'ret_from_last_weekly_close_2': 0.02570478447150304, 'ret_from_last_weekly_close_3': 0.01974090080623725, 'ret_from_last_weekly_close_4': 0.06079610428277338, 'ret_from_last_weekly_close_5': 0.017644463979708647, 'ret_from_last_weekly_close_6': -0.006835296605856911, 'ret_from_last_weekly_close_7': 0.01051461897752759, 'ret_from_last_weekly_close_8': 0.02676093665557744, 'ret_from_last_weekly_close_9': 0.011728316569081798, 'ret_from_last_weekly_close_10': 0.013812374287611284, 'ret_from_last_weekly_close_11': -0.020871208100905925, 'ret_from_last_weekly_close_12': -0.002055499182096021, 'ret_from_last_weekly_close_13': -0.05422965122271606, 'ret_from_last_weekly_close_14': -0.07161859364167444, 'ret_from_last_weekly_close_15': -0.056824948705402, 'ret_from_last_weekly_close_16': -0.05892867955652026, 'ret_from_last_weekly_close_17': -0.046403098961272704, 'ret_from_last_weekly_close_18': -0.03950425425380377, 'ret_from_last_weekly_close_19': -0.0348784406194067, 'ret_from_last_monthly_close_0': 0.0, 'ret_from_last_monthly_close_1': 0.053353027350561355, 'ret_from_last_monthly_close_2': 0.011728316569081798, 'ret_from_last_monthly_close_3': -0.05422965122271606, 'ret_from_last_monthly_close_4': -0.04246673173313287, 'ret_from_last_monthly_close_5': 0.002747254475139016, 'ret_from_last_monthly_close_6': 0.028170876966696845, 'ret_from_last_monthly_close_7': -0.0027397277411198573, 'ret_from_last_monthly_close_8': 0.014334068065203098, 'ret_from_last_monthly_close_9': 0.0575215879859412, 'ret_from_last_monthly_close_10': 0.04184417886690639, 'ret_from_last_monthly_close_11': 0.06921335434530285, 'ret_from_last_monthly_close_12': 0.09810901745304434, 'ret_from_last_monthly_close_13': 0.1489345407612177, 'ret_from_last_monthly_close_14': 0.1479400105947093, 'ret_from_last_monthly_close_15': 0.19411927202366996, 'ret_from_last_monthly_close_16': 0.25817210364605625, 'ret_from_last_monthly_close_17': 0.31362146102993194, 'ret_from_last_monthly_close_18': 0.23015538827184567, 'ret_from_last_monthly_close_19': 0.17453303617638127, 'ret_to_next_new_york_close': 0.0, 'ret_to_next_weekly_close': 0.0, 'ret_to_next_monthly_close': 0.0, 'ret_from_vwap_around_new_york_open': 0.0064302572634709065, 'ret_from_vwap_pre_new_york_close': 0.0006901085370731863, 'ret_from_vwap_post_new_york_close': 0.0023554200515487622, 'ret_from_vwap_around_new_york_close': 0.0027056999215337996, 'ret_from_vwap_pre_london_open': 0.002577949933597168, 'ret_from_vwap_post_london_open': 0.004128613940303616, 'ret_from_vwap_around_london_open': 0.0032483266636402774, 'ret_from_vwap_pre_london_close': 0.002577949933597168, 'ret_from_vwap_post_london_close': 0.004128613940303616, 'ret_from_vwap_around_london_close': 0.0032483266636402774, 'ret_from_bb_high_5_2': -0.0022752635283227463, 'ret_from_bb_high_5_3': -0.00406010496806708, 'ret_from_bb_high_10_2': -0.0016820479369901165, 'ret_from_bb_high_10_3': -0.0036587542787982485, 'ret_from_bb_high_20_2': -0.001701716230056327, 'ret_from_bb_high_20_3': -0.004499342726045796, 'ret_from_bb_high_50_2': -0.0004628226400784641, 'ret_from_bb_high_50_3': -0.002672986377806552, 'ret_from_bb_high_100_2': -0.007252215755637614, 'ret_from_bb_high_100_3': -0.011260604484831127, 'ret_from_bb_high_200_2': -0.012952221544161091, 'ret_from_bb_high_200_3': -0.01786551918734247, 'ret_from_bb_low_5_2': 0.004896130427077594, 'ret_from_bb_low_5_3': 0.006697043593368868, 'ret_from_bb_low_10_2': 0.006264084371898626, 'ret_from_bb_low_10_3': 0.008260522580536112, 'ret_from_bb_low_20_2': 0.009567720020086767, 'ret_from_bb_low_20_3': 0.012405035284129617, 'ret_from_bb_low_50_2': 0.008427006861378317, 'ret_from_bb_low_50_3': 0.010661867650648915, 'ret_from_bb_low_100_2': 0.008943969478619529, 'ret_from_bb_low_100_3': 0.013034337239986371, 'ret_from_bb_low_200_2': 0.006945992065213957, 'ret_from_bb_low_200_3': 0.011983032354507372, 'ret_from_sma_5': 0.0013040048517449776, 'ret_from_sma_10': 0.0022831256108846176, 'ret_from_sma_20': 0.003917126954845251, 'ret_from_sma_50': 0.003972213509608302, 'ret_from_sma_100': 0.0008130876678515975, 'ret_from_sma_200': -0.0030526062861033765, 'ret_from_bb_high_5d_2': -0.012154838283784386, 'ret_from_bb_high_5d_3': -0.01684475361005422, 'ret_from_bb_high_10d_2': -0.016900257070785685, 'ret_from_bb_high_10d_3': -0.02880262289034352, 'ret_from_bb_high_20d_2': -0.02044872093382466, 'ret_from_bb_high_20d_3': -0.03857089874564679, 'ret_from_bb_high_50d_2': -0.01941252356840195, 'ret_from_bb_high_50d_3': -0.0369340050288125, 'ret_from_bb_high_100d_2': -0.08228997307819697, 'ret_from_bb_high_100d_3': -0.11483704505913472, 'ret_from_bb_high_200d_2': -0.06251841961235183, 'ret_from_bb_high_200d_3': -0.09076439670219649, 'ret_from_bb_low_5d_2': 0.006827920379981478, 'ret_from_bb_low_5d_3': 0.0116304532809135, 'ret_from_bb_low_10d_2': 0.03217856829034105, 'ret_from_bb_low_10d_3': 0.04483409723994569, 'ret_from_bb_low_20d_2': 0.055514303934345754, 'ret_from_bb_low_20d_3': 0.07544222250755972, 'ret_from_bb_low_50d_2': 0.05391494191287283, 'ret_from_bb_low_50d_3': 0.07311887756080981, 'ret_from_bb_low_100d_2': 0.05965394578211214, 'ret_from_bb_low_100d_3': 0.09852784234294987, 'ret_from_bb_low_200d_2': 0.05919136354426602, 'ret_from_bb_low_200d_3': 0.09208297943295829, 'ret_from_sma_5d': -0.0027085014164338617, 'ret_from_sma_10d': 0.007338094436247111, 'ret_from_sma_20d': 0.01681166721361471, 'ret_from_sma_50d': 0.01657924504840924, 'ret_from_sma_100d': -0.013834411699597204, 'ret_from_sma_200d': -0.00351404519568721, 'ret_from_high': -0.00017145306514265712, 'ret_from_low': 0.002231569031824421, 'ret_from_open': 0.0017161493829256358, 'close_back': 0.0015444018513743885, 'close_velocity_back': 0.0044596058365273805, 'open_back': -0.0030869515167042394, 'high_back': -0.0020551471525314113, 'low_back': -0.0003436426150651428, 'volume_back': 7.80570366281097e-05, 'rsi_14': 57.51492745111251, 'rsi_28': 53.832782710980936, 'rsi_42': 51.822984980224376, 'rsi_14d': 50.96805210057667, 'rsi_28d': 50.28936115090172, 'rsi_42d': 50.08115165293575, 'relative_time_idx': 0.0}

        logging.error(f"trader.current_data_row:{trader.current_data_row.to_dict()}")
        assert_map_close(trader.current_data_row, expected_data_row1)
